<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>

  <style>
    /* Add your styles here */

    h1{
      /* margin-top: 220px; */
      margin:0px;
    }

    .topnav {
  overflow: hidden;
  background-color: #333;
  margin-top: -8px;
    margin-left: -8px;
    width: 1550px;
}

.topnav a {
  float: left;
  color: #f2f2f2;
  text-align: center;
  padding: 14px 16px;
  text-decoration: none;
  font-size: 17px;
}

.topnav a:hover {
  background-color: #ddd;
  color: black;
}

.topnav a.active {
  background-color: #aa0404;
  color: white;
}



    table {
      width: 70%; /* Adjusted width for the new columns */
      border-collapse: collapse;
      border: 2px solid black;
      margin-left: 249px
    }

    th,
    td {
      border: 1px solid #000000;
      padding: 12px;
      text-align: left;
    }

    th {
      background-color: #3498db;
      color: #000000;
      border: 1px solid black;
    }

    .delete-button {
      background-color: #e74c3c;
      color: #ffffff;
      border: none;
      padding: 8px 12px;
      cursor: pointer;
    }

    .total-row {
      font-weight: bold;
    }

    .balance-row {
      font-weight: bold;
      color: #27ae60; /* Green color for positive balance */
    }
  </style>
  <title>Summary Table</title>
</head>

<body>
  <div class="topnav">
    <a class="active" href="home.html">Home</a>
    <a href="newcal.html">Daily Estimate Bill</a>
    <a href="gst.html">Gst Bill</a>
    <a href="challan.html">Challan</a>
    <a href="excel.html">Daily Estimate Bill Records</a>
    <a href="inventory.html">Inventory</a>
    <a href="search.html">Search the product</a>
    <a href="barcode.html">Generate Barcode</a>
  </div>




  <h1 style="text-align: center;">Daily Estimate Records</h1>
  <table>
    <thead>
      <tr>
        <th>Date</th>
        <th>Bill No</th>
        <th>Total</th>
        <th>Customer Name</th>
        <th>Expenditure</th>
        <th>Particulars</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="summaryTableBody">
      <!-- Data will be added here dynamically -->
    </tbody>
    <tfoot>
      <tr class="total-row">
        <td colspan="2">Total</td>
        <td id="totalColumn"></td>
        <td colspan="2">Total Expenditure</td>
        <td id="totalExpenditureColumn"></td>
        <td></td>
      </tr>
      <tr class="balance-row">
        <td colspan="4">Balance</td>
        <td colspan="2" id="balanceColumn"></td>
        <td></td>
      </tr>
    </tfoot>
  </table>

  <button onclick="exportToExcel()" style="margin-left: 700px;
  margin-top: 36px;
  padding: 6px;
  border: 2px solid green;
  background-color: #2ecc71;
  color: white;
  border-radius: 6px;
  cursor: pointer;">Export to Excel</button>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Retrieve data from localStorage
    const summaryData = JSON.parse(localStorage.getItem('summaryData')) || [];
    const expenditureData = JSON.parse(localStorage.getItem('expenditureData')) || [];
    const particularsData = JSON.parse(localStorage.getItem('particularsData')) || [];

    // Add data to the summary table
    const summaryTableBody = document.getElementById('summaryTableBody');
    
    // Add row for Opening Balance
    const openingBalanceRow = createOpeningBalanceRow();
    summaryTableBody.appendChild(openingBalanceRow);

    // Add rows for existing data
    summaryData.forEach(summaryData => {
      const expenditureValue = getExpenditureValue(summaryData.billNo);
      const particularsValue = getParticularsValue(summaryData.billNo);
      const row = createRow(summaryData, expenditureValue, particularsValue);
      summaryTableBody.appendChild(row);
    });

    // Calculate and display total values
    calculateTotal();
  });

  function createOpeningBalanceRow() {
    const openingBalanceRow = document.createElement('tr');
    openingBalanceRow.innerHTML = `
      <td colspan="7">
        Opening Balance: 
        <input type="text" name="openingBalance" oninput="updateOpeningBalance(this)">
      </td>
    `;
    return openingBalanceRow;
  }



    function createRow(summaryData, expenditureValue, particularsValue) {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${summaryData.date}</td>
        <td>${summaryData.billNo}</td>
        <td>${summaryData.total}</td>
        <td>${summaryData.customerName}</td>
        <td><input type="text" name="expenditure" value="${expenditureValue !== undefined ? expenditureValue : ''}" oninput="updateTotal(this)"></td>
        <td><input type="text" name="particulars" value="${particularsValue !== undefined ? particularsValue : ''}" oninput="updateParticulars(this)"></td>
        <td><button class="delete-button" onclick="deleteRow(this)">Delete</button></td>
      `;
      row.dataset.billNo = summaryData.billNo;
      return row;
    }

    function getExpenditureValue(billNo) {
      const expenditureData = JSON.parse(localStorage.getItem('expenditureData')) || [];
      const entry = expenditureData.find(entry => entry.billNo === billNo);
      return entry ? entry.value : undefined;
    }

    function getParticularsValue(billNo) {
      const particularsData = JSON.parse(localStorage.getItem('particularsData')) || [];
      const entry = particularsData.find(entry => entry.billNo === billNo);
      return entry ? entry.value : undefined;
    }

    function deleteRow(button) {
  const row = button.closest('tr');
  const billNo = row.dataset.billNo;

  const summaryData = JSON.parse(localStorage.getItem('summaryData')) || [];
  const expenditureData = JSON.parse(localStorage.getItem('expenditureData')) || [];
  const particularsData = JSON.parse(localStorage.getItem('particularsData')) || [];

  // Remove the data from the arrays based on billNo
  const deletedSummaryDataIndex = summaryData.findIndex(entry => entry.billNo === billNo);
  if (deletedSummaryDataIndex !== -1) {
    summaryData.splice(deletedSummaryDataIndex, 1);
  }

  const deletedExpenditureDataIndex = expenditureData.findIndex(entry => entry.billNo === billNo);
  if (deletedExpenditureDataIndex !== -1) {
    expenditureData.splice(deletedExpenditureDataIndex, 1);
  }

  const deletedParticularsDataIndex = particularsData.findIndex(entry => entry.billNo === billNo);
  if (deletedParticularsDataIndex !== -1) {
    particularsData.splice(deletedParticularsDataIndex, 1);
  }

  // Update localStorage
  localStorage.setItem('summaryData', JSON.stringify(summaryData));
  localStorage.setItem('expenditureData', JSON.stringify(expenditureData));
  localStorage.setItem('particularsData', JSON.stringify(particularsData));

  // Remove the row from the table
  row.remove();

  // Recalculate and display total values
  calculateTotal();
}


    function calculateTotal() {
      const summaryData = JSON.parse(localStorage.getItem('summaryData')) || [];

      let totalColumn = 0;
      let totalExpenditureColumn = 0;

      summaryData.forEach(summaryData => {
        totalColumn += parseFloat(summaryData.total) || 0;
        const expenditureValue = getExpenditureValue(summaryData.billNo);
        totalExpenditureColumn += expenditureValue !== undefined ? parseFloat(expenditureValue) : 0;
      });

      const balance =  totalColumn - totalExpenditureColumn;

      document.getElementById('totalColumn').textContent = totalColumn.toFixed(2);
      document.getElementById('totalExpenditureColumn').textContent = totalExpenditureColumn.toFixed(2);
      document.getElementById('balanceColumn').textContent = balance.toFixed(2);
    }

    function updateTotal(inputField) {
      const billNo = inputField.closest('tr').dataset.billNo;
      const expenditureData = JSON.parse(localStorage.getItem('expenditureData')) || [];

      const existingEntryIndex = expenditureData.findIndex(entry => entry.billNo === billNo);

      if (existingEntryIndex !== -1) {
        // Update existing entry
        expenditureData[existingEntryIndex].value = inputField.value;
      } else {
        // Create new entry
        expenditureData.push({ billNo, value: inputField.value });
      }

      // Update localStorage
      localStorage.setItem('expenditureData', JSON.stringify(expenditureData));

      // Recalculate and display total values
      calculateTotal();
    }

    function updateParticulars(inputField) {
      const billNo = inputField.closest('tr').dataset.billNo;
      const particularsData = JSON.parse(localStorage.getItem('particularsData')) || [];

      const existingEntryIndex = particularsData.findIndex(entry => entry.billNo === billNo);

      if (existingEntryIndex !== -1) {
        // Update existing entry
        particularsData[existingEntryIndex].value = inputField.value;
      } else {
        // Create new entry
        particularsData.push({ billNo, value: inputField.value });
      }

      // Update localStorage
      localStorage.setItem('particularsData', JSON.stringify(particularsData));
    }


    // export to excel javascript
    function exportToExcel() {
  const table = document.querySelector('table');

  // Create a worksheet
  const ws = XLSX.utils.table_to_sheet(table);

  // Create a workbook and add the worksheet
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');

  // Convert the workbook to an array buffer
  const arrayBuffer = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });

  // Create a Blob from the array buffer
  const blob = new Blob([arrayBuffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });

  // Create a link element and trigger the download
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'summary_table.xlsx';
  document.body.appendChild(link);
  link.click();

  // Clean up
  document.body.removeChild(link);
  URL.revokeObjectURL(link.href);
}
// End Here
  </script>
</body>

</html>